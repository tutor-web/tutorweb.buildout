[buildout]
extensions += mr.developer
extends =
    plone-versions.cfg
    plone-sources.cfg
    versions.cfg
    sources.cfg
find-links =
    http://dist.repoze.org/
    local-eggs/
allow-picked-versions = false
quizdb-url = sqlite://

always-checkout = true
auto-checkout +=
    Products.TutorWeb
    tutorweb.content
    tutorweb.quiz
    tutorweb.quizdb
    tutorweb.tw-info
    tutorweb.theme

eggs =
    Plone
    Pillow
    Products.PloneHotfix20130618
    Products.TutorWeb
    tutorweb.content
    tutorweb.quiz
    tutorweb.quizdb
    tutorweb.tw-info
    tutorweb.theme

[instance]
recipe = plone.recipe.zope2instance
eggs = ${buildout:eggs}
zcml-additional =
    <configure xmlns="http://namespaces.zope.org/zope" xmlns:db="http://namespaces.zope.org/db">
      <include package="z3c.saconfig" file="meta.zcml" />
      <db:engine
          name="tutorweb.quizdb"
          url="${buildout:quizdb-url}"
          pool_recycle="3000"
          />
      <db:session engine="tutorweb.quizdb" />
    </configure>
zope-conf-additional =
    <product-config tutorweb.quizdb>
        coin-rpc-host 127.0.0.1
        coin-rpc-port 14242
        coin-rpc-user smileycoinrpc
        coin-rpc-pass ${buildout:quizdb-coin-pass}
        coin-rpc-walletpass ${buildout:quizdb-coin-walletpass}
    </product-config>

[plonesite]
recipe = collective.recipe.plonesite
site-id = tutor-web
instance = instance
profiles =
    tutorweb.content:default

[replicate-dump]
recipe = z3c.recipe.usercrontab
times = 0 * * * *
instance = instance
work-dir = ${buildout:directory}/var/local-dumps
script-config = --zope-conf=${buildout:directory}/parts/${replicate-dump:instance}/etc/zope.conf --work-dir=${replicate-dump:work-dir}
command = ${buildout:directory}/bin/replicate_dump ${replicate-dump:script-config} >${replicate-dump:work-dir}/dump.lastlog 2>&1

[replicate-dump-mkdir]
recipe = z3c.recipe.mkdir
paths = ${replicate-dump:work-dir}

[replicate-ingest]
recipe = z3c.recipe.usercrontab
times = 10 * * * *
instance = instance
host = MUSTBESET
host-buildout-dir = ${buildout:directory}
work-dir = ${buildout:directory}/var/${replicate-ingest:host}-dumps
remote-work-dir = ${replicate-ingest:host-buildout-dir}/var/local-dumps
script-config = --zope-conf=${buildout:directory}/parts/${replicate-ingest:instance}/etc/zope.conf --work-dir=${replicate-ingest:work-dir}
command =
    rsync --quiet --compare-dest=${replicate-ingest:work-dir}/archive/ ${replicate-ingest:host}:${replicate-ingest:remote-work-dir}/* ${replicate-ingest:work-dir}
    && ${buildout:directory}/bin/replicate_ingest ${replicate-ingest:script-config} >${replicate-ingest:work-dir}/ingest.lastlog 2>&1

[replicate-ingest-mkdir]
recipe = z3c.recipe.mkdir
paths = ${replicate-ingest:work-dir}
